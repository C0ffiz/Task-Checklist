name: Android Release

on:
  push:
    branches:
      - main
    tags:
      - 'v*'

jobs:
  build-android:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for proper versioning
      
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build web app for Capacitor
        run: npm run build:capacitor
      
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: Add Capacitor Android platform
        run: |
          if [ ! -d "android" ]; then
            npm run cap:add
          fi
      
      - name: Sync Capacitor
        run: npm run cap:sync
      
      - name: Grant execute permission to gradlew
        run: chmod +x android/gradlew
      
      - name: Build debug APK
        working-directory: android
        run: ./gradlew assembleDebug
      
      - name: Rename APK with version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          else
            VERSION="v3.1.${{ github.run_number }}"
          fi
          cp android/app/build/outputs/apk/debug/app-debug.apk \
             android/app/build/outputs/apk/debug/warframe-tasks-${VERSION}.apk
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "APK_NAME=warframe-tasks-${VERSION}.apk" >> $GITHUB_ENV
      
      - name: Upload APK as artifact
        uses: actions/upload-artifact@v4
        with:
          name: warframe-tasks-${{ env.VERSION }}
          path: android/app/build/outputs/apk/debug/${{ env.APK_NAME }}
          retention-days: 90
      
      - name: Get commit info
        id: commit_info
        run: |
          COMMIT_MESSAGE=$(git log -1 --pretty=%B | head -n 1)
          COMMIT_SHA=$(git rev-parse --short HEAD)
          BUILD_DATE=$(date +'%Y-%m-%d %H:%M:%S UTC')
          echo "COMMIT_MESSAGE=${COMMIT_MESSAGE}" >> $GITHUB_ENV
          echo "COMMIT_SHA=${COMMIT_SHA}" >> $GITHUB_ENV
          echo "BUILD_DATE=${BUILD_DATE}" >> $GITHUB_ENV
      
      - name: Create GitHub Release (for tags)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ env.VERSION }}
          body: |
            ## üì± Warframe Task Checklist - ${{ env.VERSION }}
            
            **Build Date:** ${{ env.BUILD_DATE }}
            **Commit:** ${{ env.COMMIT_SHA }}
            
            ### üì¶ Download
            - [warframe-tasks-${{ env.VERSION }}.apk](https://github.com/${{ github.repository }}/releases/download/${{ env.VERSION }}/${{ env.APK_NAME }})
            
            ### üìù Changes
            ${{ env.COMMIT_MESSAGE }}
            
            ### üîß Installation
            1. Download the APK file
            2. Enable "Install from Unknown Sources" in Android settings
            3. Install the APK
            4. Enjoy tracking your Warframe tasks!
          files: android/app/build/outputs/apk/debug/${{ env.APK_NAME }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create GitHub Release (for main branch)
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          name: Auto Release ${{ env.VERSION }}
          body: |
            ## üì± Warframe Task Checklist - Auto Build ${{ env.VERSION }}
            
            **Build Date:** ${{ env.BUILD_DATE }}
            **Commit:** ${{ env.COMMIT_SHA }}
            **Branch:** main
            
            ### üì¶ Download
            Download the APK below to install on your Android device.
            
            ### üìù Latest Changes
            ```
            ${{ env.COMMIT_MESSAGE }}
            ```
            
            ### üîß Installation Instructions
            1. Download the APK file attached below
            2. On your Android device, go to Settings ‚Üí Security
            3. Enable "Install from Unknown Sources" or "Install Unknown Apps"
            4. Open the downloaded APK file
            5. Tap "Install"
            6. Open the app and start tracking your Warframe tasks!
            
            ### ‚ÑπÔ∏è Note
            This is an automatic build from the latest commit to the main branch.
            
            ---
            *Commit: ${{ env.COMMIT_SHA }}*
          files: android/app/build/outputs/apk/debug/${{ env.APK_NAME }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
